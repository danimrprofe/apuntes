<!DOCTYPE html>
<html>
<head>
<title>ssh.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="ssh">SSH</h1>
<h2 id="%C2%BFqu%C3%A9-es-ssh">¿Qué es SSH?</h2>
<p><code>SSH</code> permite abrir una sesión de terminal desde un
cliente remoto sobre el sistema servidor, como <code>telnet</code>, pero sobre una conexión cifrada y segura.</p>
<p><img src="file:///e:/Docencia/apuntes/docs/administración_remota/img/2023-02-16-16-54-16.png" alt=""></p>
<ul>
<li>SSH utiliza por defecto el puerto 22.</li>
<li>Usa el modelo cliente-servidor y la seguridad se
basa en la criptografía.</li>
<li>SSH ofrece autenticación, confidencialidad e integridad.</li>
<li>Permite establecer conexiones seguras entre equipos a través de una red insegura.</li>
</ul>
<h2 id="instalaci%C3%B3n-openssh">Instalación openSSH</h2>
<p>La versión libre de SSH más importante es OpenSSH (www.openssh.com).</p>
<p>Necesitaremos instalar el servidor instalado en aquellas máquinas a las que queramos acceder mediante SSH</p>
<pre class="hljs"><code><div>apt install openssh-client
apt install openssh-server
</div></code></pre>
<p>También podemos instalar el metapaquete SSH. Es una forma práctica de instalar tanto el cliente como el servidor al mismo tiempo.</p>
<h2 id="arrancar-y-parar-el-servicio">Arrancar y parar el servicio:</h2>
<p>Podemos hacero con systemctl start [stop | restart | status] ssh</p>
<pre><code>service ssh start [stop | restart | status]
</code></pre>
<h2 id="configuraci%C3%B3n-de-puertos">Configuración de puertos</h2>
<p>El protocolo SSH tiene asignado el puerto 22, por lo que por defecto cliente y servidor van a intentar utilizar este puerto, a no ser que lo cambiemos.</p>
<p>En el archivo de configuración de openSSH podemos cambiar el puerto por el que nosotros queramos.</p>
<p>El servidor deberá tener abierto el puerto 22 o el que hayamos cambiado, para que pueda escuchar peticiones y se puedan conectar los clientes.</p>
<p>Al conectar con el cliente, deberemos especificar también el nuevo puerto al que nos queremos conectar.</p>
<h2 id="archivos-de-configuraci%C3%B3n">Archivos de configuración</h2>
<p>Los archivos de configuración se encuentran en <code>/etc/ssh/</code></p>
<ul>
<li>sshd_config: Configuración del servidor SSH</li>
<li>ssh_config: Configuración del cliente SSH</li>
<li>ssh_host_rsa_key: Clave RSA privada</li>
<li>ssh_host_rsa_key.pub: Clave RSA pública</li>
<li>ssh_known_hosts: claves de otras máquinas</li>
<li>~/.ssh/id_rsa: clave privada del usuario</li>
<li>~/.ssh/id_rsa.pub: clave pública del usuario</li>
</ul>
<h3 id="configuraci%C3%B3n-sshdconfig">Configuración sshd_config</h3>
<p>Indicar en que dirección escuchar, el puerto y qué versión del protocolo utilizar:</p>
<pre class="hljs"><code><div><span class="hljs-attr">Port</span> <span class="hljs-string">22</span>
<span class="hljs-comment">#ListenAddress :: (IPv6)</span>
<span class="hljs-comment">#ListenAddress 0.0.0.0 (todas las interfaces)</span>
<span class="hljs-attr">ListenAddress</span> <span class="hljs-string">192.168.100.100</span>
<span class="hljs-attr">Protocol</span> <span class="hljs-string">2</span>
</div></code></pre>
<p>Es interesante desactivar la opción que nos permita hacer login como super usuario:</p>
<pre class="hljs"><code><div><span class="hljs-attr">PermitRootLogin</span> <span class="hljs-string">without-password</span>
</div></code></pre>
<p>No permitir conexión SSH sin introducir contraseña</p>
<pre class="hljs"><code><div><span class="hljs-attr">PermitEmptyPasswords</span> <span class="hljs-string">no</span>
</div></code></pre>
<h2 id="conexi%C3%B3n-desde-el-cliente">Conexión desde el cliente</h2>
<p>Para conectar mediante ssh utilizamos o bien la IP o el nombre de dominio de la máquina.</p>
<pre><code>ssh 10.0.0.1
ssh servidor
</code></pre>
<p>Si no indicamos nada más, se va a intentar iniciar sesión en la máquina remota con el mismo usuario con el que estamos en la máquina local.</p>
<p>Para iniciar sesión con otro usuario:</p>
<pre class="hljs"><code><div><span class="hljs-meta">john@elmuro$</span><span class="bash"> ssh pepe@servidor</span>
</div></code></pre>
<p>En la máquina servidor tendrá que haber un usuario llamado pepe, y tendremos que saber su contraseña</p>
<h3 id="configuraci%C3%B3n-del-cliente">Configuración del cliente</h3>
<p>Necesitamos crear un archivo de configuración /home/john/.ssd/config
Si no existe la carpeta:</p>
<pre class="hljs"><code><div><span class="hljs-meta">john@elmuro$</span><span class="bash"> <span class="hljs-built_in">cd</span> ~</span>
<span class="hljs-meta">john@elmuro$</span><span class="bash"> mkdir .ssh</span>
</div></code></pre>
<p>Crear archivo de configuración:</p>
<pre class="hljs"><code><div><span class="hljs-meta">john@elmuro$</span><span class="bash"> nano config</span>
</div></code></pre>
<p>Completar para cada host que queramos configurar</p>
<p>Si queremos tener opciones que apliquen a todos los host: Host *</p>
<pre class="hljs"><code><div><span class="hljs-meta">john@elmuro$</span><span class="bash"> cat .ssh/config</span>
Host internalia
    Hostname 172.0.0.9
    User sansa
    Port 22
<span class="hljs-meta">john@elmuro$</span><span class="bash"> ssli invernalia sansaP172.0.0.9’s password:</span>
Welcome to Ubuntu 18.04.1 LTS (GNU/Linux 4.15.0-39-generic x86_64)
</div></code></pre>
<p>Podemos hacer lo mismo en la otra máquina. Tenemos que tener en cuenta
Cada usuario tiene su propio archivo de configuración
No nos funcionará esta configuración si lo hacemos desde otro usuario
Tendríamos que crear otro fichero de configuración o copiar el que ya tenemos</p>
<h3 id="crear-alias">Crear alias</h3>
<p>Podemos definir alias, e incluso guardarlas en .bashrc para que permanezcan
en la máquina tras reiniciar.</p>
<pre><code>alias invernalia=’172.0.0.7’
alias invernalia=’ssh -p 22 john@172.0.0.7’
</code></pre>
<h3 id="crear-registros-dns">Crear registros DNS</h3>
<p>Crear un RR en el servidor DNS server IN A 172.0.0.7</p>
<h3 id="prioridad-entre-configuraciones">Prioridad entre configuraciones</h3>
<p>Existe la posibilidad de conflictos entre las mismas opciones especificadas en archivos, en el mismo comando, etc.
Existe una prioridad entre las diferentes configuraciones
Las opciones se leen en el siguiente orden:</p>
<ol>
<li>Línea de comandos</li>
<li>Archivo de configuración del usuario</li>
<li>Archivo de configuración del sistema</li>
</ol>
<h2 id="ejecutar-comandos-directamente">Ejecutar comandos directamente</h2>
<p>Ejecutar comandos sin entrar en shell
Especificando el comand a continuación de ssh</p>
<pre><code>ssh user@10.0.2.2 df -h (espacio libre)
</code></pre>
<h2 id="editar-archivos-remotamente">Editar archivos remotamente</h2>
<p>También podemos editar archivos remotamente:</p>
<pre><code>vim scp://remotehost/remotefile
</code></pre>
<p>La ruta base será la de home del usuario (<code>/home/usuario/remotefile</code>).
Desde VIM podemos navegar por el sistema de ficheros a través de las carpetas.</p>
<h2 id="autenticaci%C3%B3n-por-clave-p%C3%BAblica">Autenticación por clave pública</h2>
<p>Ssh-keygen es una herramienta para crear nuevos pares de claves de autenticación para SSH.
Dichos pares de claves se utilizan para automatizar inicios de sesión
Generar un par de claves:</p>
<pre><code>ssh-keygen -t rsa
</code></pre>
<p>La pública se guardará en <code>~/.ssh/id_rsa.pub</code>
La privada se guardará en <code>~/.ssh/id_rsa</code></p>
<h3 id="copiar-clave-p%C3%BAblica">Copiar clave pública</h3>
<p>Ahora deberíamos copiar la clave pública en todas las máquinas a las que quiera conectar:
Copiarlas en la carpeta ~/.ssh/authorized_keys a mano. Para ello:</p>
<pre><code>scp /home/user/.ssh/id_rsa.pub dani@10.0.2.2:./ssh/authorized_keys
</code></pre>
<p>Utilizar comando específico:</p>
<pre><code>ssh-copy-id remoteuser@remotehost
</code></pre>
<p>Como el equipo remoto ahora tiene nuestra clave pública, nos podemos conectar a él sin necesidad de contraseñas</p>
<h2 id="comprobar-usuarios-conectados">Comprobar usuarios conectados</h2>
<p>Podemos utilizar el comando who para ver cuántos usuarios están conectados al sistema.</p>
<pre><code>who
</code></pre>
<p>También podemos consultar los accesos en el archivo:</p>
<pre><code>tail -10 /var/log/auth.log
</code></pre>
<h2 id="permisos-de-administrador">Permisos de administrador</h2>
<p>¿Qué sucede si necesitamos permisos de administrador?</p>
<p>Los usuarios que pueden ejecutar comandos SUDO tienen que pertenecer al grupo SUDO.</p>
<p>Tenemos que iniciar sesión con un usuario que pueda hacer sudos.</p>
<p>Agregar un usuario al grupo:</p>
<pre><code>sudo adduser sansa sudo
</code></pre>
<p>Comprobación</p>
<p>Cambiar sesión al usuario que queremos probar
Ejecutar sudo apt update y comprobar si deja hacerlo
Comprobar los miembros del grupo SUDO</p>
<pre><code>cat /etc/group | grep sudo
</code></pre>
<h2 id="transferencia-de-archivos">Transferencia de archivos</h2>
<p>El comando <code>scp</code> permite hacer copias seguras de archivos o directorios completos ('*'). Es una versión segura de la orden <code>cp</code> y además funciona en red.</p>
<h3 id="copia-b%C3%A1sica">Copia básica</h3>
<p>Para copiar un archivo:</p>
<pre><code>scp backup sansa@172.0.0.9:/home/sansa/
</code></pre>
<h3 id="crear-dummy-files-para-pruebas">Crear dummy files para pruebas</h3>
<p>Podemos crear archivos de diferentes tamaños para hacer pruebas.
Truncate hace más grande o más pequeño un archivo.
Con -s le indicaremos el tamaño en bytes</p>
<pre><code>truncate -s 200MB backup01
</code></pre>
<h3 id="copiar-varios-archivos-al-mismo-tiempo">Copiar varios archivos al mismo tiempo</h3>
<p>Podemos especificar varios archivos en lugar de uno. Si no indicamos nada, estarán en la carpeta en la que nos situamos.</p>
<p>Podemos indicar varios archivos de diferentes carpetas, siempre que indiquemos sus rutas absolutas</p>
<pre><code>scp backup01 backup02 backup03 sansa@172.0.0.9:/home/sansa/
</code></pre>
<p>Podemos utilizar expresiones especiales y comodines para hacer referencia a archivos que tienen un nombre parecido</p>
<pre><code>scp backup[1-3] sansa@172.0.0.9:/home/sansa/
</code></pre>
<p>Con el argumento -r podemos copiar recursivamente una carpeta y todo su contenido</p>
<pre><code>scp -r backups/ sansa@172.0.0.9:/home/sansa/
</code></pre>
<h3 id="traer-archivos-desde-un-ordenador-remoto">Traer archivos desde un ordenador remoto</h3>
<p>En este caso, estamos en la máquina a la que queremos transferir los archivos. Por ello el destino será esta misma máquina.</p>
<p>El origen será en este caso otra máquina. Por eso la pondremos en primer lugar</p>
<p>Como segundo argumento podemos indicar la ruta de la máquina actual en la que quiero guardar los archivos</p>
<p>Si queremos guardarlo en la carpeta actual, lo podemos indicar con un punto (.)</p>
<pre><code>scp sansa@172.0.0.9:/home/sansa/backup05 .
</code></pre>
<h3 id="tarear-archivos">Tarear archivos</h3>
<p>Podemos agrupar todos los archivos en un tar y enviarlo:</p>
<pre><code>tar cvf backup.tar *
scp backup.tar elmuro:/home/john
</code></pre>
<h2 id="buenas-pr%C3%A1cticas">Buenas prácticas</h2>
<p>Al tratarse de un servicio tan delicado, conviene hacer una serie de modificaciones para mejorar el funcionamiento y evitar posibles ataques.</p>
<ul>
<li>https://www.howtoforge.com/ssh-best-practices</li>
<li>https://www.thegeekstuff.com/2011/05/openssh-options/</li>
</ul>
<h2 id="otras-herrramientas-de-gesti%C3%B3n-remota">Otras herrramientas de gestión remota</h2>
<h3 id="putty">Putty</h3>
<p>Cliente SSH, entre otros
Se usa para interactuar con el servidor directamente, a través de una interfaz de comandos.</p>
<ul>
<li>https://www.solvetic.com/tutoriales/article/787-primeros-pasos-con-putty-y-su-configuracion/</li>
</ul>
<h3 id="winscp">WinSCP</h3>
<p>Se utiliza para transferir archivos desde y hasta un servidor</p>
<p>https://www.ionos.es/digitalguide/hosting/cuestiones-tecnicas/primeros-pasos-con-winscp/</p>
<h3 id="mremote">mRemote</h3>
<p>Administrador de conexiones remotas
De código abierto
Con pestañas
Multiprotocolo</p>
<p>https://mremoteng.org/download</p>
<h2 id="terminal-server">Terminal server</h2>
<p>Por problemas de criptografía, es posible que necesitemos cambiar opciones en cliente
Deberemos agregar una clave al registro de windows en la máquina local.
Abrir <code>cmd</code> como administrador o <code>powershell</code> y ejecutar lo siguiente:</p>
<pre class="hljs"><code><div>reg add <span class="hljs-string">"HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System\CredSSP\Parameters"</span> /f /v AllowEncryptionOracle /t REG_DWORD /d <span class="hljs-number">2</span>
</div></code></pre>
<h2 id="conectar">Conectar</h2>
<p>Abrir el cliente de conexión a escritorio remoto desde la máquina local</p>
<ul>
<li>Conectar a localhost:9090</li>
<li>Cambiar la cuenta de usuario y conectar con el usuario administrador del servidor</li>
</ul>
<p>Podemos ejecutar la MV sin mostrarla utilizando <code>shift+click</code> en el botón iniciar de la MV</p>

</body>
</html>
