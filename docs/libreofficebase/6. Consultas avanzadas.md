# 6. CONSULTAS AVANZADAS

# 6.1. Entorno de trabajo en vista Diseño 

Ya trabajamos en **modo diseño** , pero ahora vamos a ver en detalle todos los elementos de esta forma de realizar consultas. 

Primero, podemos observar que la vista diseño está dividida horizontalmente en tres partes: 

- La parte superior, con la barra de herramientas
- La central, donde se muestran las tablas seleccionadas para la consulta
- La inferior, donde cada columna representa cada uno de los campos a mostrar junto con una serie de opciones relacionadas para el filtrado de los resultados. 

![](media/image84.png)

## 6.2. Creación en vista Diseño de consulta sobre varias tablas 

Vamos a crear nuestra primera consulta completamente en vista Diseño. En particular, vamos a crear una consulta que nos muestre todos los actores que protagonizan películas junto con los datos de la película, incluido el nombre del género. Es decir, vamos a construir una consulta que utiliza las cuatro tablas de nuestra base de datos. 

Para empezar, nos vamos a la ventana principal, a la sección Consultas y seleccionamos la tarea **Crear consulta en vista Diseño**.

![](media/image85.png)

**Seleccionar tablas a utilizar en la consulta**

Nada más entrar en el modo Diseño, nos mostrará una ventana donde indicar las tablas que queremos incluir en la consulta que se va a crear. En nuestro caso, vamos a añadir las cuatro disponibles y veremos como nos muestra las relaciones existentes automáticamente.

Las puedes recolocar un poco para que te sea más fácil ver las relaciones

![](media/image86.png)

**Especificar criterios de la consulta**

A continuación vamos a especificar que queremos que los resultados de la consulta se muestran ordenados por los apellidos y el nombre de los intérpretes.

![](media/image87.png)

Para incluir los campos de la **tabla peliculas** vamos a seleccionar Peliculas:* y así no tenemos que incluir los campos uno a uno

![](media/image88.png)

Para seleccionar los campos de la tabla Interpretes no hemos utilizado la posibilidad `Interpretes.*` porque es necesario seleccionar cada campo individualmente, ya que vamos a establecer algún criterio de ordenación en función de alguno de los campos de la tabla. 

Como en nuestro caso vamos a mostrar los resultados ordenados en función de los apellidos y el nombre de los intérpretes (ver Figura 6.4) necesitamos seleccionar uno a uno cada campo de Interpretes. 

Para terminar, vamos a seleccionar el campo Nombre de la **tabla Generos** y, en el alias, vamos a poner “NombreGenero”, para distinguirlo de los campos ya seleccionados, Nombre de la tabla Interpretes y genero de la **tabla peliculas**.

![](media/image89.png)

Guardamos la consulta con el nombre “ConsultaTotal” y al ejecutarla el resultado es el siguiente:

![](media/image90.png)

**Creación de consultas que incluyen funciones**

Vamos a crear una consulta que realiza operaciones sobre los resultados.

Así, vamos a crear una consulta que muestre el nombre de cada género almacenado y el total de películas que tenemos de cada género. 

Es decir, el objetivo es realizar una consulta sobre Generos y Peliculas de manera que agrupemos las filas devueltas en función de cada género para así poder contarlas y poder saber el número de películas asociadas a cada uno de ellos. 

El resultado de nuestra consulta, con las filas que tenemos actualmente en Generos y Peliculas, debe ser como la siguiente: 

![](media/image91.png)

Para empezar, elegimos las tablas sobre las que vamos a realizar la consulta, Generos y Peliculas.

![](media/image92.png)

Los campos que necesitamos son, por una lado Nombre de Generos, que es sobre el que agruparemos los resultados devueltos y, por otro, un campo de la **tabla peliculas** que estemos seguros que siempre tendrá un valor (no estará vacío) para cada fila de Peliculas. 

Por ejemplo, podemos elegir el campo **id_pelicula** que siempre va a tener valor para cada película. Los campos seleccionados se muestran.

![](media/image93.png)

A continuación, debemos asociar la función correspondiente a cada uno de los dos campos. 

**Especificar la función**

En primer lugar, hemos dicho que queremos agrupar los resultados en función de cada género, para ello vamos a incluir la función “Agrupar” asociada al campo Nombre de Generos. 

![](media/image94.png)

En segundo lugar, lo que queremos es contar las películas relacionadas con cada género. Esto último lo conseguimos asociando la función “Cantidad” al campo Id_pelicula de Peliculas.

![](media/image94.png)

Guardamos entonces la consulta como “Peliculas de cada Genero” 

![](media/image95.png)

Al lanzarla nos encontramos una pantalla como esta: 

![](media/image96.png" id="image97">

Como vemos, la cabecera con el total de películas está mostrando la función que estamos utilizando junto con el nombre del campo.

Si queremos que el resultado aparezca como el que mostraremos en la figura., es decir, con una cabecera significativa, debemos añadir el alias “Total de Peliculas”.

![](media/image95.png" id="image98">

## 6.3 Vistas. Consultas sobre vistas 

### ¿Qué son las vistas?

Las vistas son un tipo especial de consultas almacenadas que, a nivel de bases de datos, se tratan como una tabla más. 

¿Qué ocurre si necesitamos realizar una consulta no sobre una tabla sino sobre los resultados de otra consulta? 

La respuesta es que debemos convertir la consulta en una vista para que se pueda manejar como si de una tabla se tratara. 

Para ver las beneficios de usar vistas, vamos a realizar una consulta que nos devuelva el valor medio de las películas asociadas a cada género. 

Esta consulta no se puede realizar directamente sobre las tablas Generos y Peliculas sino sobre la consulta Películas de cada Género una vez convertida en vista.

###  Convertir una consulta en una vista

Para convertir una consulta en una vista nos situamos en la ventana principal  en la sección “Consultas” y: 

- Seleccionamos la consulta que queramos convertir con el botón derecho del ratón. 
- Del menú que se despliega seleccionamos la opción “Crear como vista”. 

![](media/image97.png" id="image99">

Se nos despliega entonces una ventana donde tenemos que poner un nombre a la vista, escribimos “PeliculasCadaGenero” y aceptamos. Ya hemos convertido la consulta en una vista y podemos ver que ya es así si nos situamos en la sección “Tablas” de la ventana principal (ver Figura 6.15). Podemos observar que se usa un icono distinto para representar vistas y distinguirlas de las tablas. 

![](media/image98.png" id="image100">

### Crear una consulta sobre la vista

Una vez que ya tenemos la vista, vamos a crear una consulta sobre ella. Para empezar, vemos que al entrar en vista Diseño para crear una nueva consulta ya nos aparece PeliculasCadaGenero como si de una tabla más se tratara y la elegimos como única tabla de la consulta. 

![](media/image99.png" id="image101">

Como sólo queremos que nos devuelva el valor medio de las películas de cada género seleccionamos el campo Total de Peliculas y le asociamos la función “Promedio” junto con el alias “Media de cada género”. 

![](media/image100.png" id="image102">

Para ver que la consulta hace lo que esperamos en la propia vista Diseño (ver Figura 6.18), la lanzamos antes de guardarla utilizando el botón “Ejecutar” y, si devuelve el valor esperado, ya hemos terminado. 

![](media/image101.png" id="image103">
